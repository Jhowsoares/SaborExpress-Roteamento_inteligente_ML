<!DOCTYPE html>
<html>
<head>
    <title>Mapa de Rotas - Sabor Express</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 20px; font-family: 'Segoe UI', Arial, sans-serif; background: #f8f9fa; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .back-btn { 
            background: #6c757d; 
            color: white; 
            padding: 10px 20px; 
            text-decoration: none; 
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            margin-bottom: 20px;
            transition: background 0.3s;
        }
        .back-btn:hover { background: #5a6268; color: white; text-decoration: none; }
        #map { 
            height: 600px; 
            width: 100%; 
            border-radius: 8px; 
            border: 2px solid #dee2e6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .header { 
            text-align: center; 
            margin-bottom: 25px; 
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        .cluster-info { 
            background: linear-gradient(135deg, #e3f2fd, #bbdefb); 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 8px;
            border-left: 4px solid #2196f3;
        }
        .loading { 
            text-align: center; 
            padding: 40px; 
            color: #6c757d;
        }
        .stats-bar {
            display: flex;
            justify-content: space-around;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #e9ecef;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #495057;
        }
        .stat-label {
            font-size: 0.85em;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/admin/roteamento/" class="back-btn">
            ‚Üê Voltar ao Painel de Roteamento
        </a>
        
        <div class="header">
            <h1>üó∫Ô∏è Mapa de Rotas em Tempo Real</h1>
            <p class="text-muted">Visualiza√ß√£o geogr√°fica das entregas otimizadas por IA</p>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="total-nos">0</div>
                <div class="stat-label">Pontos no Mapa</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-rotas">0</div>
                <div class="stat-label">Rotas Otimizadas</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-clusters">0</div>
                <div class="stat-label">Clusters Ativos</div>
            </div>
        </div>

        <div id="map"></div>

        <div class="cluster-info">
            <h5>üéØ Sistema de Otimiza√ß√£o Ativo</h5>
            <p><strong>Algoritmos:</strong> K-Means (clustering) + A* (rota)</p>
            <p><strong>Status:</strong> <span style="color: #28a745;">‚óè</span> Processando dados reais de S√£o Paulo</p>
            <p><strong>Coverage:</strong> Regi√£o Central SP (-23.55, -46.63)</p>
        </div>
    </div>

    <script>
        // Inicializar mapa centrado em S√£o Paulo
        var map = L.map('map').setView([-23.5505, -46.6333], 12);

        // Adicionar tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors | Sabor Express IA'
        }).addTo(map);

        // Adicionar marcador do restaurante
        var restauranteIcon = L.divIcon({
            html: 'üè†',
            className: 'restaurante-marker',
            iconSize: [30, 30]
        });

        L.marker([-23.5505, -46.6333], {icon: restauranteIcon})
            .addTo(map)
            .bindPopup(`
                <div style="text-align: center;">
                    <h5 style="margin: 0; color: #dc3545;">üè† Sabor Express</h5>
                    <p style="margin: 5px 0;"><strong>Centro de Distribui√ß√£o</strong></p>
                    <small>üìç Centro, S√£o Paulo<br>(-23.5505, -46.6333)</small>
                </div>
            `)
            .openPopup();

        // Buscar dados da API
        fetch('/admin/roteamento/api/grafo')
            .then(response => response.json())
            .then(data => {
                console.log('üì° Dados recebidos da API:', data);
                
                // Atualizar estat√≠sticas
                document.getElementById('total-nos').textContent = data.total_nos || data.nos.length;
                document.getElementById('total-rotas').textContent = data.total_arestas || data.arestas.length;
                document.getElementById('total-clusters').textContent = new Set(data.arestas.map(a => a.cluster)).size;
                
                // Cores para diferentes clusters
                const clusterColors = {
                    1: '#d62728', 2: '#1f77b4', 3: '#ff7f0e', 
                    4: '#2ca02c', 5: '#9467bd', 6: '#8c564b'
                };

                // Adicionar marcadores das localiza√ß√µes
                data.nos.forEach(node => {
                    if (node.tipo !== 'restaurante') {
                        const marker = L.marker([node.latitude, node.longitude])
                            .addTo(map)
                            .bindPopup(`
                                <div style="min-width: 200px;">
                                    <h6 style="margin: 0 0 8px 0; color: #495057;">üìç ${node.nome}</h6>
                                    <p style="margin: 0; font-size: 0.9em;">
                                        <strong>Tipo:</strong> ${node.tipo}<br>
                                        <strong>Coordenadas:</strong><br>
                                        ${node.latitude.toFixed(4)}, ${node.longitude.toFixed(4)}
                                    </p>
                                </div>
                            `);
                    }
                });

                // Adicionar rotas (arestas)
                data.arestas.forEach(edge => {
                    const sourceNode = data.nos.find(n => n.id == edge.source);
                    const targetNode = data.nos.find(n => n.id == edge.target);
                    
                    if (sourceNode && targetNode) {
                        const color = clusterColors[edge.cluster] || '#666666';
                        
                        L.polyline([
                            [sourceNode.latitude, sourceNode.longitude],
                            [targetNode.latitude, targetNode.longitude]
                        ], {
                            color: color,
                            weight: 4,
                            opacity: 0.7,
                            dashArray: edge.tipo === 'rota_principal' ? null : '5, 10'
                        }).addTo(map).bindPopup(`
                            <strong>üîÑ Rota Cluster ${edge.cluster}</strong><br>
                            ${sourceNode.nome} ‚Üí ${targetNode.nome}
                        `);
                    }
                });

            })
            .catch(error => {
                console.error('‚ùå Erro ao carregar dados:', error);
                
                // Fallback: Adicionar alguns pontos de exemplo
                const pontosExemplo = [
                    {nome: "Rep√∫blica", lat: -23.5435, lng: -46.642},
                    {nome: "Santa Cec√≠lia", lat: -23.535, lng: -46.649},
                    {nome: "Consola√ß√£o", lat: -23.555, lng: -46.660}
                ];

                pontosExemplo.forEach(ponto => {
                    L.marker([ponto.lat, ponto.lng])
                        .addTo(map)
                        .bindPopup(`<strong>üìç ${ponto.nome}</strong><br>Ponto de entrega`);
                });

                document.getElementById('total-nos').textContent = pontosExemplo.length + 1;
                document.getElementById('total-rotas').textContent = '3';
                document.getElementById('total-clusters').textContent = '2';
            });

        // Adicionar controle de camadas
        L.control.layers(null, null, {position: 'topright'}).addTo(map);
    </script>
</body>
</html>