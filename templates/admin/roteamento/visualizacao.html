{% extends "admin/base.html" %}

{% block title %}Visualiza√ß√£o Unificada - Admin{% endblock %}
{% block page_title %}üéØ Visualiza√ß√£o Unificada{% endblock %}

{% block content %}
<div class="visualizacao-container">

    <!-- Header Unificado -->
    <div class="visualizacao-header">
        <div class="header-info">
            <h2>Vis√£o Integrada da Opera√ß√£o Log√≠stica</h2>
            <p>Acompanhe clusters, rotas otimizadas, grafos e m√©tricas em um √∫nico painel.</p>
        </div>

        <div class="header-stats">
            <div class="stat">
                <span class="stat-number">{{ total_pedidos }}</span>
                <span class="stat-label">Pedidos</span>
            </div>
            <div class="stat">
                <span class="stat-number">{{ total_entregadores }}</span>
                <span class="stat-label">Entregadores</span>
            </div>
        </div>
    </div>

    <!-- Navega√ß√£o entre vis√µes -->
    <div class="view-selector">
        <button class="view-btn active" data-view="mapa">üó∫Ô∏è Mapa</button>
        <button class="view-btn" data-view="grafo">üï∏Ô∏è Grafo</button>
        <button class="view-btn" data-view="metricas">üìä M√©tricas</button>
    </div>

    {% if not tem_dados %}
    <div class="empty-state">
        <div class="empty-icon">üì¶</div>
        <h3>Nenhum dado dispon√≠vel</h3>
        <p>Execute a otimiza√ß√£o para visualizar informa√ß√µes log√≠sticas.</p>
        <a href="{{ url_for('roteamento.index') }}" class="btn btn-primary">üöÄ Executar Otimiza√ß√£o</a>
    </div>

    {% else %}
    <div class="view-container">

        <!-- MAPA -->
        <iframe src="{{ url_for('roteamento.mapa_rotas') }}" class="view-frame active" id="view-mapa"></iframe>

        <!-- GRAFO -->
        <iframe src="{{ url_for('roteamento.grafo_rotas') }}" class="view-frame" id="view-grafo"></iframe>

        <!-- M√âTRICAS -->
        <iframe src="{{ url_for('roteamento.metricas') }}" class="view-frame" id="view-metricas"></iframe>

    </div>

    <!-- An√°lise r√°pida -->
    <div class="analise-rapida">
        <h3>üìå Insights Autom√°ticos</h3>
        <ul>
            <li>Clusters com maior volume s√£o <strong>priorizados</strong> por entregadores pr√≥ximos.</li>
            <li>Rotas otimizadas reduzem dist√¢ncia m√©dia em <b>30‚Äì50%</b>.</li>
            <li>A an√°lise de grafo permite detectar n√≥s cr√≠ticos do processo.</li>
        </ul>
    </div>

    <!-- Heatmap hor√°rio -->
    {% if relatorio.heatmap %}
    <div class="heat-card">
        <h3>‚è∞ Hor√°rios Cr√≠ticos</h3>
        <canvas id="graficoHeat"></canvas>
    </div>
    {% endif %}

    <!-- A√ß√µes -->
    <div class="acoes-section">
        <a href="{{ url_for('roteamento.index') }}" class="btn btn-success">üöÄ Nova Otimiza√ß√£o</a>
        <button onclick="window.print()" class="btn btn-secondary">üñ®Ô∏è Exportar</button>
    </div>

    {% endif %}
</div>

<script>
document.querySelectorAll('.view-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelector('.view-btn.active').classList.remove('active');
        btn.classList.add('active');

        document.querySelector('.view-frame.active').classList.remove('active');
        document.getElementById('view-' + btn.dataset.view).classList.add('active');
    });
});
</script>

<style>
.visualizacao-container {
    max-width: 1400px;
    margin: auto;
}

.visualizacao-header {
    background: linear-gradient(135deg, #7b4397, #dc2430);
    color: white;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
}

.header-info h2 { margin: 0; }
.header-stats {
    display: flex; gap: 2rem; margin-top: 1rem;
}

.view-selector {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
}
.view-btn {
    padding: .6rem 1.2rem;
    border: none;
    border-radius: 8px;
    background: #eee;
    cursor: pointer;
    font-weight: bold;
    transition: .2s;
}
.view-btn.active {
    background: #4CAF50;
    color: white;
}

.view-frame {
    width: 100%;
    height: 650px;
    border: none;
    display: none;
    border-radius: 8px;
    box-shadow: 0 2px 20px rgba(0,0,0,.1);
}
.view-frame.active { display: block; }

.analise-rapida {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    margin-top: 2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,.05);
}

.heat-card {
    background: white;
    padding: 1.5rem;
    margin-top: 2rem;
    border-radius: 8px;
}

.acoes-section {
    text-align: center;
    padding: 2rem;
}
</style>
{% endblock %}
